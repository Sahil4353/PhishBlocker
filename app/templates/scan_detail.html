{% extends "base.html" %}
{% import "_macros.html" as macros %}
{% block title %}Scan #{{ scan.id }} · PhishBlocker{% endblock %}

{% block content %}
<header style="margin-bottom:1rem;">
    <h1 style="margin:0;">Scan Detail</h1>
    <p style="color:#666;margin:0.25rem 0 0;">ID: {{ scan.id }} · {{ scan.created_at or "—" }}</p>
</header>

{% if ok %}
<div style="padding:0.6rem 1rem;margin-bottom:1rem;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:8px;color:#065f46;">
    ✅ Thanks! Your feedback was saved.
</div>
{% endif %}

<section style="background:#fafafa;border:1px solid #e5e5e5;border-radius:8px;padding:1rem;margin-bottom:1rem;">
    <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
        <strong>Label:</strong>
        {{ macros.label_chip(scan.label) }}
        <strong style="margin-left:1rem;">Confidence:</strong>
        <span>{{ '%.0f'|format((scan.confidence or 0) * 100) }}%</span>
    </div>
    <div style="margin-top:0.75rem;color:#444;">
        <div><strong>Subject:</strong> {{ scan.subject or "(no subject)" }}</div>
        <div><strong>From:</strong> {{ scan.sender or "(unknown)" }}</div>
    </div>
</section>

{% if scan.probs %}
<section style="margin-bottom:1rem;">
    <h2 style="margin:0 0 0.5rem 0;font-size:1.1rem;">Class probabilities</h2>
    <div style="display:flex;flex-direction:column;gap:0.5rem;">
        {% for cls, p in scan.probs.items() %}
        {% set pct = (p * 100.0) | round(1) %}
        <div>
            <div style="display:flex;justify-content:space-between;font-size:0.9rem;">
                <strong>{{ cls|capitalize }}</strong>
                <span>{{ pct }}%</span>
            </div>
            <div style="height:10px;background:#eee;border-radius:6px;overflow:hidden;">
                <div style="height:10px;width:{{ pct }}%;background:#4b8bff;border-radius:6px;"></div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<section style="margin-bottom:1rem;">
    <h2 style="margin:0 0 0.5rem 0;font-size:1.1rem;">Reasons</h2>
    {% if scan.reasons and scan.reasons|length %}
    <ul style="margin:0.25rem 0;padding-left:1.2rem;">
        {% for r in scan.reasons %}
        <li>{{ r }}</li>
        {% endfor %}
    </ul>
    {% else %}
    <p style="color:#666;">No reasons recorded.</p>
    {% endif %}
</section>

<section>
    <h2 style="margin:0 0 0.5rem 0;font-size:1.1rem;">Body preview</h2>
    <pre
        style="white-space:pre-wrap;background:#fafafa;border:1px solid #e5e5e5;border-radius:8px;padding:1rem;max-height:320px;overflow:auto;">{{ scan.body_preview or "" }}</pre>
</section>

<!-- ✅ Feedback Form -->
<section style="margin-top:2rem;background:#fafafa;border:1px solid #e5e5e5;border-radius:8px;padding:1rem;">
    <h2 style="margin-top:0;">Feedback</h2>
    <p style="color:#555;margin-top:0.3rem;">Mark the actual label if this classification was incorrect.</p>

    <form method="post" action="{{ request.url_for('add_feedback_page', scan_id=scan.id) }}">
        <div class="row" style="gap:1rem;align-items:center;margin:0.5rem 0 1rem;">
            <label><input type="radio" name="user_label" value="safe" required> Safe</label>
            <label><input type="radio" name="user_label" value="spam"> Spam</label>
            <label><input type="radio" name="user_label" value="phishing"> Phishing</label>
        </div>
        <textarea name="notes" rows="3" placeholder="Optional notes (why you corrected this)…"
            style="width:100%;border-radius:6px;padding:0.5rem;border:1px solid #ccc;"></textarea>
        <div style="margin-top:0.5rem;">
            <button type="submit"
                style="padding:0.4rem 1rem;border-radius:6px;border:1px solid #e5e5e5;background:#fff;cursor:pointer;">
                Submit Feedback
            </button>
        </div>
    </form>
</section>

<p style="margin-top:1.5rem;">
    <a href="{{ request.url_for('history') }}">← Back to History</a>
</p>
{% endblock %}
